{% comment %}
Args:
  List[str] x_labels
  List[int] y_values
  int current_day_x_index
  str first_day
  str current_day
  str last_day
  Budget budget
  int prediction predicted expense at end_date
{% endcomment %}

<canvas id="budget-projection-chart" style="height: 300px; width: 100%"></canvas>
<script>
  const ctx = document.getElementById('budget-projection-chart').getContext('2d');

  function get_gradient() {
    const gradient = ctx.createLinearGradient(0, 500, 0, 0);
    gradient.addColorStop(0, 'transparent');
    gradient.addColorStop(1, 'rgba(127,75,75,0.15)');
    return gradient;
  }

  const xs = [
    {% for label in x_labels %}'{{ label }}',{% endfor %}
  ];
  const ys = [
    {% for value in y_values %}{{ value }},{% endfor %}
  ];
  const limit = [
    {% for label in x_labels %}{{ budget.limit }},{% endfor %}
  ]

  const data = {
    labels: xs,
    datasets: [
      {
        label: 'Expense',
        backgroundColor: get_gradient(),
        borderColor: accentColorBlue,
        data: ys,
        elements: {
          line: {
            cubicInterpolationMode: 'monotone',  // curve line
          },
        },
        segment: {
          // draw projection as dashed line
          borderDash: ctx => {
            if(ctx.p1.parsed.x > {{ current_day_x_index }}) {
              // dash line length=5 gap=5
              // see https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/setLineDash#parameters
              return [5, 5];
            }
            return undefined;
          },
          // draw over-expenses as red
          borderColor: ctx => {
            if(ctx.p1.parsed.y > {{ budget.limit }}) {
              return accentColorRed;
            }
            return undefined;
          }
        },
        fill: true,
        order: 1,  // draw first, so it will be below
        pointBackgroundColor: accentColorBlue,
        pointRadius: ctx => {
          console.log(ctx, ctx.dataIndex, ctx.parsed.x);
          if(ctx.dataIndex === {{ current_day_x_index }}) {
            return 5;
          }
          return undefined;
        }
      },
      {
        label: 'Limit',
        backgroundColor: accentColorYellow,
        borderColor: accentColorYellow,
        data: limit,
      },
    ]
  };

  const myChart = new Chart(ctx, {
    type: 'line',
    data: data,
    options: {
      scales: {
        x: {
          ticks: {
            autoSkip: false  // show all labels
          },
        },
        y: {
          beginAtZero: true,
          grid: {
            display:false
          },
          ticks: {
            callback: function(value, index, values) {
              return humanFormat(value);
            }
          }
        }
      },
      elements: {
        point: {
          radius: 0,  // hide point
        },
      },
      plugins: {
        legend: {
          display: false  // hide legend
        }
      }
    }
  });
</script>